---
import { getCollection } from "astro:content";
import DocLayout from "../../layouts/DocLayout.astro";
import { Endpoint } from "../../components/Endpoint";
import Mermaid from "../../components/Mermaid";
import { SqlDiagram } from "../../components/SqlDiagram";
import { marked } from "marked";

export async function getStaticPaths() {
  const docs = await getCollection("docs");
  return docs.map((doc) => ({
    params: { slug: doc.id },
    props: { doc },
  }));
}

const { doc } = Astro.props;
const { data } = doc;

// Render markdown content to HTML
const htmlContent = data.content ? marked.parse(data.content) : "";
---

<DocLayout title={data.title} slug={doc.id}>
  <article class="prose">
    {htmlContent && <div set:html={htmlContent} />}

    {
      data.sql && (
        <div class="not-prose">
          <SqlDiagram client:only="react" sql={data.sql} />
        </div>
      )
    }

    {
      data.diagram && !data.sql && (
        <div class="not-prose">
          <Mermaid client:only="react" chart={data.diagram} />
        </div>
      )
    }

    {
      data.endpoints && data.endpoints.length > 0 && (
        <div class="mt-12 space-y-8">
          <h2 class="text-2xl font-bold mb-6 mt-14 pb-2 border-b border-main-border text-[var(--color-sidebar-text-active)]">
            API Reference
          </h2>
          {data.endpoints.map((endpoint) => (
            <Endpoint
              method={endpoint.method}
              path={endpoint.path}
              description={endpoint.description}
            />
          ))}
        </div>
      )
    }
  </article>
</DocLayout>
